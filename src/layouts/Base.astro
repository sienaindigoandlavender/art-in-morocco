---
interface Props {
  title: string;
  description?: string;
  image?: string;
  settings?: Record<string, string>;
}

const { title, description, image, settings: passedSettings } = Astro.props;
import { getSiteSettings, getNexusFooterLinks, getNexusPoweredBy, getNexusLegalPages, getNexusSite, type NexusFooterLink } from '../lib/supabase';

const settings = passedSettings || await getSiteSettings();
const footerLinks = await getNexusFooterLinks();
const poweredBy = await getNexusPoweredBy();
const nexusSite = await getNexusSite();
const legalPages = await getNexusLegalPages();

const footerColumns = new Map<number, { title: string; links: NexusFooterLink[] }>();
footerLinks.forEach(link => {
  if (!footerColumns.has(link.column_number)) {
    footerColumns.set(link.column_number, { title: link.column_title || '', links: [] });
  }
  footerColumns.get(link.column_number)!.links.push(link);
});
const sortedColumns = Array.from(footerColumns.entries()).sort((a, b) => a[0] - b[0]);
const desc = description || settings.meta_description || 'Morocco Art Guide — Moroccan artists, galleries, movements and institutions from the Casablanca School to contemporary.';
const currentPath = Astro.url.pathname;
let canonicalPath = currentPath;
if (canonicalPath !== '/' && canonicalPath.endsWith('/')) canonicalPath = canonicalPath.slice(0, -1);
const canonicalUrl = `https://moroccoartguide.com${canonicalPath}`;
const SITE = 'https://moroccoartguide.com';
---

<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>{title}</title>
  <meta name="title" content={title}>
  <meta name="description" content={desc}>
  <meta name="author" content="Slow Morocco">
  <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1">

  <link rel="canonical" href={canonicalUrl}>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">

  <meta property="og:type" content="website">
  <meta property="og:url" content={canonicalUrl}>
  <meta property="og:title" content={title}>
  <meta property="og:description" content={desc}>
  <meta property="og:image" content={image || `${SITE}/og-image.jpg`}>
  <meta property="og:site_name" content="Morocco Art Guide">
  <meta property="og:locale" content="en_US">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content={title}>
  <meta name="twitter:description" content={desc}>
  <meta name="twitter:image" content={image || `${SITE}/og-image.jpg`}>

  <!-- GEO: AI-optimized structured data -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "WebSite",
    "name": "Morocco Art Guide",
    "alternateName": "MAG",
    "url": SITE,
    "description": "Comprehensive guide to Moroccan visual art — artists, movements, galleries, and institutions from the Casablanca School to contemporary",
    "inLanguage": "en",
    "publisher": {
      "@type": "Organization",
      "name": "Slow Morocco",
      "url": "https://www.slowmorocco.com",
      "address": { "@type": "PostalAddress", "addressLocality": "Marrakech", "addressCountry": "MA" }
    },
    "potentialAction": {
      "@type": "SearchAction",
      "target": `${SITE}/search?q={search_term_string}`,
      "query-input": "required name=search_term_string"
    }
  })} />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-0PDYPERR1Y"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-0PDYPERR1Y');
  </script>
</head>
<body>
  <header class="site-header">
    <div class="container header-inner">
      <a href="/" class="logo">
        <span class="logo-mark">MAG</span>
        <span class="logo-full">Morocco Art Guide</span>
      </a>
      <nav class="main-nav">
        <a href="/artists">Artists</a>
        <a href="/artworks">Works</a>
        <a href="/movements">Movements</a>
        <a href="/institutions">Spaces</a>
        <a href="/map">Map</a>
        <a href="/glossary">Glossary</a>
        <a href="/itineraries">Itineraries</a>
        <a href="/tips">Tips</a>
      </nav>
      <button class="nav-toggle" aria-label="Menu">
        <span></span><span></span>
      </button>
    </div>
  </header>

  <main>
    <slot name="hero" />
    <slot />
  </main>

  <!-- FOOTER: 3-level ombre -->
  <footer class="site-footer">
    <!-- Level 1: Site-specific links -->
    <div class="footer-l1">
      <div class="container">
        <div class="footer-site-links">
          <a href="/artists">Artists</a>
          <a href="/artworks">Works</a>
          <a href="/movements">Movements</a>
          <a href="/institutions">Spaces</a>
          <a href="/cities">Cities</a>
          <a href="/map">Map</a>
          <a href="/glossary">Glossary</a>
          <a href="/itineraries">Itineraries</a>
          <a href="/tips">Tips</a>
          <a href="/about">About</a>
        </div>
      </div>
    </div>

    <!-- Level 2: Navigation columns -->
    <div class="footer-l2">
      <div class="container">
        <div class="footer-grid">
          <div class="footer-col footer-brand">
            <a href="/" class="footer-logo">Morocco Art Guide</a>
            <p class="footer-blurb">Moroccan artists, galleries, movements<br>and institutions.</p>
          </div>
          {sortedColumns.map(([_, col]) => (
            <div class="footer-col">
              {col.title && <h4>{col.title}</h4>}
              <ul>
                {col.links.map(link => (
                  <li><a href={link.link_href}>{link.link_label}</a></li>
                ))}
              </ul>
            </div>
          ))}
        </div>
      </div>
    </div>

    <!-- Level 3: Legal + powered by -->
    <div class="footer-l3">
      <div class="container footer-l3-inner">
        <div class="legal-links">
          {legalPages.map(page => (
            <a href={`/legal/${page.page_id}`}>{page.page_title}</a>
          ))}
        </div>
        <span class="copyright">© {new Date().getFullYear()} {nexusSite?.site_name || 'Morocco Art Guide'}</span>
        <a href="https://www.slowmorocco.com" target="_blank" rel="noopener" class="powered-by">Powered by Slow Morocco</a>
      </div>
    </div>
  </footer>

  <script>
    document.querySelector('.nav-toggle')?.addEventListener('click', () => {
      document.querySelector('.main-nav')?.classList.toggle('open');
    });
  </script>
</body>
</html>

<style is:global>
  /* ═══════════════════════════════════════════════════════════════════════════
     DESIGN TOKENS — Cold Contemporary Gallery
  ═══════════════════════════════════════════════════════════════════════════ */
  :root {
    --font-display: 'Instrument Serif', Georgia, serif;
    --font-body: 'Inter', -apple-system, sans-serif;

    --color-bg: #ffffff;
    --color-surface: #f5f5f5;
    --color-ink: #0a0a0a;
    --color-ink-light: #3d3d3d;
    --color-ink-muted: #8c8c8c;
    --color-accent: #0a0a0a;
    --color-accent-hover: #333;
    --color-border: #e0e0e0;
    --color-border-dark: #b0b0b0;
    --color-red: #c23b22;

    --color-dark-bg: #0a0a0a;
    --color-dark-surface: #141414;
    --color-dark-text: #f0f0f0;
    --color-dark-muted: #707070;

    --space-xs: 0.5rem;
    --space-sm: 1rem;
    --space-md: 2rem;
    --space-lg: 4rem;
    --space-xl: 6rem;
    --space-2xl: 10rem;

    --max-width: 1400px;
    --max-width-narrow: 800px;
  }

  *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
  html { font-size: 16px; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }

  body {
    font-family: var(--font-body);
    background: var(--color-bg);
    color: var(--color-ink);
    line-height: 1.6;
    font-weight: 300;
  }

  .container { max-width: var(--max-width); margin: 0 auto; padding: 0 var(--space-md); }
  a { color: inherit; text-decoration: none; }
  img { max-width: 100%; height: auto; display: block; }

  h1, h2, h3, h4, h5 { font-family: var(--font-display); font-weight: 400; line-height: 1.1; }
  h1 { font-size: clamp(2.8rem, 6vw, 4.5rem); letter-spacing: -0.02em; }
  h2 { font-size: clamp(1.8rem, 3.5vw, 2.8rem); letter-spacing: -0.02em; }
  h3 { font-size: clamp(1.15rem, 2vw, 1.4rem); }

  .micro-label {
    font-family: var(--font-body);
    font-size: 0.65rem;
    font-weight: 500;
    letter-spacing: 0.16em;
    text-transform: uppercase;
    color: var(--color-ink-muted);
  }

  /* ═══════════════════════════════════════════════════════════════════════════
     HEADER — minimal black bar
  ═══════════════════════════════════════════════════════════════════════════ */
  .site-header {
    position: sticky;
    top: 0;
    z-index: 100;
    background: var(--color-ink);
    color: white;
  }

  .header-inner {
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 3rem;
  }

  .logo { display: flex; align-items: center; gap: 0.6rem; }

  .logo-mark {
    font-family: var(--font-body);
    font-size: 0.65rem;
    font-weight: 600;
    letter-spacing: 0.2em;
    background: white;
    color: var(--color-ink);
    padding: 0.15rem 0.4rem;
  }

  .logo-full {
    font-family: var(--font-body);
    font-size: 0.78rem;
    font-weight: 400;
    letter-spacing: 0.06em;
    color: rgba(255,255,255,0.8);
  }

  .main-nav { display: flex; gap: 1.6rem; }

  .main-nav a {
    font-size: 0.72rem;
    font-weight: 400;
    color: rgba(255,255,255,0.6);
    letter-spacing: 0.06em;
    text-transform: uppercase;
    transition: color 0.2s;
  }

  .main-nav a:hover { color: white; }

  .nav-toggle {
    display: none;
    background: none; border: none; cursor: pointer;
    width: 24px; height: 18px; position: relative;
  }

  .nav-toggle span {
    display: block; width: 100%; height: 1px;
    background: white; position: absolute; left: 0;
    transition: 0.2s;
  }

  .nav-toggle span:first-child { top: 4px; }
  .nav-toggle span:last-child { bottom: 4px; }

  /* ═══════════════════════════════════════════════════════════════════════════
     FOOTER — 3-level ombre
  ═══════════════════════════════════════════════════════════════════════════ */
  .site-footer { margin-top: var(--space-2xl); }

  /* Level 1 — site links */
  .footer-l1 {
    background: #1f1f1f;
    padding: var(--space-md) 0;
    border-bottom: 1px solid rgba(255,255,255,0.06);
  }

  .footer-site-links {
    display: flex;
    gap: 2rem;
    justify-content: center;
  }

  .footer-site-links a {
    font-size: 0.75rem;
    font-weight: 400;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: rgba(255,255,255,0.5);
    transition: color 0.2s;
  }

  .footer-site-links a:hover { color: white; }

  /* Level 2 — navigation */
  .footer-l2 {
    background: #161616;
    padding: var(--space-lg) 0;
  }

  .footer-grid {
    display: grid;
    grid-template-columns: 1.5fr repeat(auto-fit, minmax(140px, 1fr));
    gap: var(--space-lg);
  }

  .footer-logo {
    font-family: var(--font-display);
    font-size: 1.2rem;
    color: white;
    display: block;
    margin-bottom: 0.6rem;
  }

  .footer-blurb {
    font-size: 0.8rem;
    color: rgba(255,255,255,0.4);
    line-height: 1.5;
    font-weight: 300;
  }

  .footer-col h4 {
    font-family: var(--font-body);
    font-size: 0.6rem;
    font-weight: 600;
    letter-spacing: 0.14em;
    text-transform: uppercase;
    color: rgba(255,255,255,0.3);
    margin-bottom: 0.8rem;
  }

  .footer-col ul { list-style: none; }
  .footer-col li { margin-bottom: 0.35rem; }

  .footer-col li a {
    font-size: 0.8rem;
    font-weight: 300;
    color: rgba(255,255,255,0.55);
    transition: color 0.2s;
  }

  .footer-col li a:hover { color: white; }

  /* Level 3 — legal + powered by */
  .footer-l3 {
    background: #0e0e0e;
    padding: 0.8rem 0;
  }

  .footer-l3-inner {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .legal-links { display: flex; gap: 1.5rem; }

  .legal-links a {
    font-size: 0.65rem;
    color: rgba(255,255,255,0.3);
    transition: color 0.2s;
  }

  .legal-links a:hover { color: rgba(255,255,255,0.6); }

  .copyright { font-size: 0.65rem; color: rgba(255,255,255,0.2); }

  .powered-by {
    font-size: 0.65rem;
    color: rgba(255,255,255,0.25);
    transition: color 0.2s;
  }

  .powered-by:hover { color: rgba(255,255,255,0.5); }

  /* ═══════════════════════════════════════════════════════════════════════════
     SHARED PAGE STYLES
  ═══════════════════════════════════════════════════════════════════════════ */
  .page-header {
    padding: var(--space-xl) 0 var(--space-lg);
  }

  .page-header .page-desc {
    max-width: 600px;
    margin-top: var(--space-sm);
    color: var(--color-ink-muted);
    font-size: 1rem;
    font-weight: 300;
    line-height: 1.6;
  }

  .section-header { margin-bottom: var(--space-md); }
  .section-header h2 { margin-top: 0.3rem; }

  section { margin-bottom: var(--space-xl); }

  .section-inner {
    max-width: var(--max-width);
    margin: 0 auto;
    padding: 0 var(--space-md);
  }

  /* Card grid — clean, no border radius */
  .card-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1px;
    background: var(--color-border);
  }

  .card {
    background: white;
    transition: background 0.3s;
  }

  .card:hover { background: var(--color-surface); }

  .card-image {
    aspect-ratio: 4/3;
    overflow: hidden;
    background: #f0f0f0;
  }

  .card-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.6s cubic-bezier(0.16, 1, 0.3, 1);
    filter: grayscale(20%);
  }

  .card:hover .card-image img {
    transform: scale(1.05);
    filter: grayscale(0%);
  }

  .card-body { padding: 1rem 1rem 1.2rem; }
  .card-body h3 { margin-bottom: 0.2rem; }
  .card-meta { font-size: 0.78rem; color: var(--color-ink-muted); font-weight: 300; }

  .cta-link {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    font-size: 0.78rem;
    font-weight: 500;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    color: var(--color-ink);
    padding: 0.6rem 0;
    border-bottom: 1px solid var(--color-ink);
    transition: opacity 0.2s;
    margin-top: var(--space-md);
  }

  .cta-link:hover { opacity: 0.6; }

  /* ═══════════════════════════════════════════════════════════════════════════
     RESPONSIVE
  ═══════════════════════════════════════════════════════════════════════════ */
  @media (max-width: 768px) {
    .nav-toggle { display: block; }
    .main-nav {
      display: none;
      position: absolute;
      top: 3rem; left: 0; right: 0;
      background: var(--color-ink);
      flex-direction: column;
      padding: var(--space-sm) var(--space-md);
      gap: 0.8rem;
    }
    .main-nav.open { display: flex; }
    .main-nav a { font-size: 0.85rem; }
    .footer-grid { grid-template-columns: 1fr; }
    .footer-l3-inner { flex-direction: column; text-align: center; }
    .legal-links { flex-wrap: wrap; justify-content: center; }
    .footer-site-links { flex-wrap: wrap; gap: 1rem; }
    .logo-full { display: none; }
  }
</style>
